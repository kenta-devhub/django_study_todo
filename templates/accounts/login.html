<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% if form_type == 'login' %}ログイン{% else %}新規登録{% endif %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    {% load static %}
    <link rel="stylesheet" href="{% static 'accounts/css/login_styles.css' %}">
  </head>
  <body>
    <main class="d-flex flex-column align-items-center justify-content-center bg-dark vh-100">
      <div class="form-container text-secondary">

        {# フラッシュメッセージ #}
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}

        {# フォーム開始 #}
        <form method="POST"
              action="{% if form_type == 'login' %}{% url 'login' %}{% else %}{% url 'signup' %}{% endif %}"
              class="w-100" novalidate>
          {% csrf_token %}
          <h1 class="h4 mb-3 fw-normal text-light">
            {% if form_type == 'login' %}ログイン{% else %}新規登録{% endif %}
          </h1>

          {# 全体エラー（non_field_errors） #}
          {% if form and form.non_field_errors %}
            <div class="alert alert-danger py-2">
              {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
            </div>
          {% endif %}

          {# サインアップのみ：ユーザー名（任意） #}
          {% if form_type == 'signup' %}
            <div class="form-floating mb-3">
              <input type="text"
                     name="username"
                     class="form-control{% if form and form.errors.username %} is-invalid{% endif %}"
                     id="floatingUsername"
                     placeholder="ユーザー名を入力してください"
                     autocomplete="nickname"
                     value="{{ form.username.value|default_if_none:'' }}">
              <label for="floatingUsername">ユーザー名（未入力なら自動）</label>
              {% if form and form.errors.username %}
                <div class="invalid-feedback">
                  {% for e in form.errors.username %}{{ e }}{% endfor %}
                </div>
              {% endif %}
            </div>
          {% endif %}

          {# メールアドレス（ログイン時は username フィールド名） #}
          <div class="form-floating mb-3">
            <input type="email"
                   name="{% if form_type == 'login' %}username{% else %}email{% endif %}"
                   class="form-control{% if form_type == 'login' and form and form.errors.username %} is-invalid{% endif %}{% if form_type == 'signup' and form and form.errors.email %} is-invalid{% endif %}"
                   id="floatingEmail"
                   placeholder="name@example.com"
                   autocomplete="email"
                   autofocus
                   value="{% if form_type == 'login' %}{{ form.username.value|default_if_none:'' }}{% else %}{{ form.email.value|default_if_none:'' }}{% endif %}">
            <label for="floatingEmail">メールアドレス</label>
            {% if form_type == 'login' and form and form.errors.username %}
              <div class="invalid-feedback">
                {% for e in form.errors.username %}{{ e }}{% endfor %}
              </div>
            {% elif form_type == 'signup' and form and form.errors.email %}
              <div class="invalid-feedback">
                {% for e in form.errors.email %}{{ e }}{% endfor %}
              </div>
            {% endif %}
          </div>

          {# パスワード #}
          <div class="form-floating mb-3">
            <input type="password"
                   name="{% if form_type == 'login' %}password{% else %}password1{% endif %}"
                   class="form-control{% if form_type == 'login' and form and form.errors.password %} is-invalid{% endif %}{% if form_type == 'signup' and form and form.errors.password1 %} is-invalid{% endif %}"
                   id="floatingPassword"
                   placeholder="パスワード"
                   autocomplete="{% if form_type == 'login' %}current-password{% else %}new-password{% endif %}">
            <label for="floatingPassword">パスワード</label>
            {% if form_type == 'login' and form and form.errors.password %}
              <div class="invalid-feedback">
                {% for e in form.errors.password %}{{ e }}{% endfor %}
              </div>
            {% elif form_type == 'signup' and form and form.errors.password1 %}
              <div class="invalid-feedback">
                {% for e in form.errors.password1 %}{{ e }}{% endfor %}
              </div>
            {% endif %}
          </div>

          {# サインアップのみ：確認用パスワード #}
          {% if form_type == 'signup' %}
            <div class="form-floating mb-3">
              <input type="password"
                     name="password2"
                     class="form-control{% if form and form.errors.password2 %} is-invalid{% endif %}"
                     id="floatingPassword2"
                     placeholder="確認用パスワード"
                     autocomplete="new-password">
              <label for="floatingPassword2">確認用パスワード</label>
              {% if form and form.errors.password2 %}
                <div class="invalid-feedback">
                  {% for e in form.errors.password2 %}{{ e }}{% endfor %}
                </div>
              {% endif %}
            </div>
          {% endif %}

          {# next（リダイレクト）を維持 #}
          {% if next %}
            <input type="hidden" name="next" value="{{ next }}">
          {% endif %}

          <button class="btn btn-primary w-100 py-2" type="submit">
            {% if form_type == 'login' %}ログイン{% else %}登録{% endif %}
          </button>
        </form>

        {# 画面遷移リンク #}
        <div class="d-flex justify-content-end align-items-center mt-2">
          {% if form_type == 'login' %}
            <a href="{% url 'signup' %}" class="text-secondary">新規登録はこちら</a>
          {% else %}
            <a href="{% url 'login' %}" class="text-secondary">ログインはこちら</a>
          {% endif %}
        </div>

      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
