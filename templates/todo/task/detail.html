{% extends 'base/base.html' %}
{% block content %}
<div class="row m-2">
  <!-- 左：タスク詳細 -->
  <div class="col-md-6">
    <div class="card">
      <h5 class="card-header text-center text-secondary bg-white border-bottom">タスク詳細</h5>
      <div class="card-body">
        <div class="row my-sm-3 align-items-center">
          <div class="col-md-2 text-muted">タイトル</div>
          <div class="col-md-10">
            <input type="text" class="form-control" value="{{ obj.title }}" readonly>
          </div>
        </div>

        <div class="row my-sm-3">
          <div class="col-md-2 text-muted">説明</div>
          <div class="col-md-10">
            <div class="form-control" style="white-space:pre-wrap">{{ obj.description|default:"-" }}</div>
          </div>
        </div>

        <div class="row my-sm-3 align-items-center">
          <div class="col-md-2 text-muted">期限</div>
          <div class="col-md-10">
            <input type="text" class="form-control" value="{{ obj.due_date|date:'Y-m-d'|default:'-'}}" readonly>
          </div>
        </div>

        <div class="row my-sm-3 align-items-center">
          <div class="col-md-2 text-muted">優先度</div>
          <div class="col-md-10">
            <input type="text" class="form-control" value="{{ obj.get_priority_display }}" readonly>
          </div>
        </div>

        <div class="row my-sm-3 align-items-center">
          <div class="col-md-2 text-muted">完了</div>
          <div class="col-md-10">
            <input type="text" class="form-control" value="{{ obj.completed|yesno:'完了,未完了' }}" readonly>
          </div>
        </div>

        <div class="row my-4 justify-content-center">
          <a class="col-md-3 mx-md-1 my-1 btn btn-primary btn-lg" href="{% url 'todo:task_update' obj.pk %}">編集</a>
          <a class="col-md-3 mx-md-1 my-1 btn btn-danger btn-lg" href="{% url 'todo:task_delete' obj.pk %}">削除</a>
          <a class="col-md-3 mx-md-1 my-1 btn btn-secondary btn-lg" href="{% url 'todo:task_list' %}">一覧へ</a>
        </div>
      </div>
    </div>
  </div>

  <!-- 右：変更履歴 -->
  <div class="col-md-6">
    <div class="card">
      <h5 class="card-header text-center text-secondary bg-white border-bottom">変更履歴</h5>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-striped table-hover border align-middle">
            <thead class="table-dark">
              <tr>
                <th class="text-center">更新日時</th>
                <th class="text-center">更新者</th>
                <th class="text-center">種別</th>
                <th class="text-center">内容</th>
              </tr>
            </thead>
            <tbody>
              {% for record in history_changes %}
                <tr>
                  <td class="text-center">{{ record.history_date|date:"Y/m/d H:i:s" }}</td>
                  <td class="text-center">{{ record.history_user|default:"システム" }}</td>
                  <td class="text-center">
                    {% if record.history_type == '+' %}追加
                    {% elif record.history_type == '~' %}更新
                    {% elif record.history_type == '-' %}削除
                    {% else %}不明{% endif %}
                    {% if record.history_change_reason %}（{{ record.history_change_reason }}）{% endif %}
                  </td>
                  {% if record.changes %}
                    <td class="text-center" style="white-space:normal;">
                      {% for field, change in record.changes.items %}
                        {% if field == 'due_date' %}
                          {{ field }}: {{ change.old|date:"Y/m/d" }} → {{ change.new|date:"Y/m/d" }}<br>
                        {% else %}
                          {{ field }}: {{ change.old }} → {{ change.new }}<br>
                        {% endif %}
                      {% endfor %}
                    </td>
                  {% elif record.history_type == '+' %}
                    <td class="text-center">新規登録</td>
                  {% else %}
                    <td class="text-center">変更なし</td>
                  {% endif %}
                </tr>
              {% empty %}
                <tr>
                  <td class="text-center" colspan="4">変更履歴はありません</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
