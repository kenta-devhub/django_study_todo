{% extends "base/base.html" %}
{% block title %}Kanban{% endblock %}
{% block content %}

<h1 class="h4 mb-3">Kanban</h1>

<div class="row g-3" id="kanban">
  {# 列数を取得し、12 / 列数 を計算 #}
  {% with cols=columns|length %}
    {% widthratio 1 cols 12 as md_cols %} {# 1/cols*12 → 12/cols #}

    {% for key, label, items in columns %}
      <div class="col-12 col-md-{{ md_cols }}">
        <div class="card border-secondary">
          <div class="card-header bg-body-secondary">{{ label }}</div>
          <ul class="list-group list-group-flush min-vh-25" id="col-{{ key }}" data-status="{{ key }}">
            {% for t in items %}
              <li class="list-group-item" data-id="{{ t.id }}">
                <div class="d-flex justify-content-between">
                  <strong class="text-truncate">{{ t.title }}</strong>
                  <span class="badge {% if t.priority == 3 %}text-bg-danger{% elif t.priority == 2 %}text-bg-primary{% else %}text-bg-secondary{% endif %}">
                    {{ t.get_priority_display }}
                  </span>
                </div>
                <div class="small text-secondary">期限: {{ t.due_date|default:"-" }}</div>
              </li>
            {% empty %}
              <li class="list-group-item text-secondary">なし</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endfor %}
  {% endwith %}
</div>


<!-- SortableJS（CDN） -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
  // CSRF  # DjangoのCSRFトークンをCookieから取得するためのヘルパ
  function getCookie(name) {  // 指定したCookie名の値を返す関数
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');  // Cookie文字列を正規表現で検索して値部分を抽出
    return m ? m.pop() : '';  // マッチしたら末尾（値）を返し、無ければ空文字を返す
  }
  const csrftoken = getCookie('csrftoken');  // Django既定のCookie名 'csrftoken' からCSRFトークンを取得

  // data-status を持つ全カラムを自動初期化（列数が増減してもOK）
  document.querySelectorAll('ul[data-status]').forEach(function(col){  // Kanbanボード上の各列<ul>を一括で走査
    new Sortable(col, {  // SortableJSでドラッグ＆ドロップを有効化（列ごとにインスタンス化）
      group: "tasks",  // 同一group名のリスト間でアイテム移動を許可
      animation: 150,  // ドラッグ時のアニメーション時間（ミリ秒）
      onAdd: function (evt) {  // 別リストへアイテムが「追加」されたときに発火するハンドラ
        const li = evt.item;  // ドロップされた<li>要素（移動アイテム）
        const id = li.dataset.id;  // タスクID（<li data-id="..."> で埋め込み前提）
        const newStatus = evt.to.dataset.status;  // 追加先の列<ul data-status="..."> から新ステータスを取得
        fetch(`/api/tasks/${id}/status/`, {  // DRFのカスタムアクション（PATCH /api/tasks/:id/status/）へ更新要求
          method: "PATCH",  // ステータス更新に部分更新（PATCH）を使用
          headers: {  // 必要ヘッダを付与
            "Content-Type": "application/json",  // リクエストボディはJSON
            "X-CSRFToken": csrftoken  // DjangoのCSRF対策ヘッダ
          },
          body: JSON.stringify({status: newStatus})  // サーバへ送る新しいステータス値
        }).then(r => {  // レスポンス受信後の処理
          if (!r.ok) {  // ステータスコードが2xx以外＝失敗
            alert("更新に失敗しました");  // ユーザーへ失敗通知
            // 元の位置に戻す
            evt.from.insertBefore(li, evt.from.children[evt.oldIndex]);  // 失敗時は移動前のリストに元の順序で差し戻し
          }
        }).catch(() => {  // ネットワークエラーなど例外時
          alert("通信エラー");  // ユーザーへエラー通知
          evt.from.insertBefore(li, evt.from.children[evt.oldIndex]);  // 通信失敗でも差し戻し
        });
      }
    });
  });  // すべてのKanban列に対するSortable初期化完了

</script>

<style>
  .min-vh-25 { min-height: 25vh; }
</style>
{% endblock %}
